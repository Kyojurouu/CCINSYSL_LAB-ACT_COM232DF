import pandas as pd
import spacy
import os

print("Loading SpaCy model...")
nlp = spacy.load("en_core_web_sm")

print("Loading dataset...")
df = pd.read_csv('anomalies_detected_evidence.csv')
print(f"Dataset loaded with {len(df)} rows.")

entities = []
print("Extracting entities...")
for idx, message in df['message'].items():
    doc = nlp(str(message))
    for ent in doc.ents:
        entities.append({
            'row_id': idx,
            'messages': message,
            'text': ent.text,
            'label': ent.label_,
            'description': spacy.explain(ent.label_)
        })
print(f"Extraction complete. Found {len(entities)} entities.")

entities_df = pd.DataFrame(entities)

output_file = 'extracted2_entities.csv'

if os.path.exists(output_file):
    print(f"File {output_file} already exists. It will be overwritten.")
    os.remove(output_file)

try:
    entities_df.to_csv(output_file, index=False)
    print(f"Extracted entities saved to {output_file}")
except PermissionError:
    print(f"Permission denied when trying to write to {output_file}. Please close any programs using this file and try again.")
except Exception as e:
    print(f"An error occurred: {e}")
